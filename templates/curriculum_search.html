{% extends 'base.html' %}
{% load static %}

{% block title %}Curriculum Search - School Search{% endblock %}

{% block content %}
<div class="page-container">
    <div class="mb-4" style="margin-bottom: var(--space-5);">
        <h1 style="margin-bottom: var(--space-4);">Search for a curriculum</h1>
        <div style="display: flex; gap: var(--space-3); max-width: 600px;">
            <input type="text" id="curriculum-search-input" value="{{ search_query }}" placeholder="Search for a curriculum"
                class="form-input" style="flex: 1;" autocomplete="off">
            <button type="button" id="curriculum-search-btn" class="btn btn-primary">
                <span class="material-icons">search</span>
                Search
            </button>
        </div>
    </div>

    <div class="grid-2" id="curriculum-results">
        {% for curriculum in curricula %}
        <a href="{% url 'curriculum_detail' curriculum.id %}" class="card fade-in card-link" style="padding: var(--space-4);">
            <div style="margin-bottom: var(--space-3);">
                <h2 style="font-size: 18px; margin-bottom: var(--space-2); color: var(--text-primary);">{{ curriculum.name }}</h2>
                {% if curriculum.abbreviation %}
                <span style="color: var(--text-secondary); font-weight: 600; font-size: 12px; padding: 3px 10px; background: var(--bg-tertiary); border-radius: var(--radius-pill); display: inline-block; border: 1px solid var(--border-light);">{{ curriculum.abbreviation }}</span>
                {% endif %}
            </div>
            {% if curriculum.description %}
            <p style="color: var(--text-secondary); margin: 0; line-height: 1.5; font-size: 13px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{{ curriculum.description }}</p>
            {% endif %}
        </a>
        {% empty %}
        <div class="empty-state" style="grid-column: 1 / -1;">
            <span class="material-icons">menu_book</span>
            <p>No curricula found. Try a different search term!</p>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('curriculum-search-input');
    const searchBtn = document.getElementById('curriculum-search-btn');
    const resultsContainer = document.getElementById('curriculum-results');
    let searchTimeout;

    function performSearch(query) {
        if (!query.trim()) {
            // If empty, show all
            window.location.href = '{% url "curriculum_search" %}';
            return;
        }

        fetch('{% url "curriculum_search" %}?q=' + encodeURIComponent(query), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            resultsContainer.innerHTML = '';
            
            if (data.curricula.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <span class="material-icons">menu_book</span>
                        <p>No curricula found. Try a different search term!</p>
                    </div>
                `;
                return;
            }

            data.curricula.forEach(curriculum => {
                const card = document.createElement('a');
                card.href = curriculum.url;
                card.className = 'card fade-in card-link';
                card.style.padding = 'var(--space-4)';
                
                const abbreviation = curriculum.abbreviation ? `
                    <span style="color: var(--text-secondary); font-weight: 600; font-size: 12px; padding: 3px 10px; background: var(--bg-tertiary); border-radius: var(--radius-pill); display: inline-block; border: 1px solid var(--border-light);">${curriculum.abbreviation}</span>
                ` : '';
                
                const description = curriculum.description ? `
                    <p style="color: var(--text-secondary); margin: 0; line-height: 1.5; font-size: 13px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${curriculum.description}</p>
                ` : '';
                
                card.innerHTML = `
                    <div style="margin-bottom: var(--space-3);">
                        <h2 style="font-size: 18px; margin-bottom: var(--space-2); color: var(--text-primary);">${curriculum.name}</h2>
                        ${abbreviation}
                    </div>
                    ${description}
                `;
                
                resultsContainer.appendChild(card);
            });
        })
        .catch(error => {
            console.error('Search error:', error);
        });
    }

    // Dynamic search as you type
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        
        searchTimeout = setTimeout(() => {
            if (query.length >= 1 || query.length === 0) {
                performSearch(query);
            }
        }, 300); // 300ms debounce
    });

    // Search button click
    searchBtn.addEventListener('click', function() {
        performSearch(searchInput.value.trim());
    });

    // Enter key in search input
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch(this.value.trim());
        }
    });
});
</script>
{% endblock %}